apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: failed-deployments
  namespace: monitoring
  labels:
    app: failed-deployments
spec:
  releaseName: failed-deployments
  chart:
    spec:
      chart: job
      sourceRef:
        kind: GitRepository
        name: chart-job
        namespace: flux-system
      interval: 1m
  interval: 5m
  values:
    schedule: "0 9 * * 1-5" # interval 9:00am Monday to Friday
    disableActiveClusterCheck: true
    concurrencyPolicy: "Forbid"
    failedJobsHistoryLimit: 3
    startingDeadlineSeconds: 300
    successfulJobsHistoryLimit: 3
    backoffLimit: 3
    restartPolicy: Never
    runAsRoot: true
    kind: CronJob
    image: hmctspublic.azurecr.io/failed-deployments:prod-3d1f775-20260107103638Z #{"$imagepolicy": "flux-system:failed-deployments"}
    imagePullPolicy: Always
    environment:
      CLUSTER_NAME: "cft-${CLUSTER_FULL_NAME}-aks"
      ARTIFACT_URL: "http://source-controller.flux-system.svc.cluster.local."
      API_SERVER_URL: "https://kubernetes.default.svc.cluster.local"
    secrets:
      SLACK_WEBHOOK:
        secretRef: helm-base-versions
        key: slack-webhook
    nodeSelector:
      agentpool: linux
    tolerations:
      - key: dedicated
        effect: NoSchedule
        operator: Equal
        value: jobs
