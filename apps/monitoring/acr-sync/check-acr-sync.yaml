apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: check-acr-sync
  namespace: monitoring
  labels:
    app: check-acr-sync
spec:
  chart:
    spec:
      chart: cronjob-chart
      sourceRef:
        kind: GitRepository
        name: chart-repo
        namespace: flux-system
      interval: 1m
  interval: 5m
  values:
    cronJob:
      schedule: "*/15 * * * *"
      concurrencyPolicy: "Forbid"
      failedJobsHistoryLimit: 3
      startingDeadlineSeconds: 300
      jobTemplate:
        spec:
          backoffLimit: 3
          template:
            spec:
              restartPolicy: Never
              containers:
                - name: check-acr-sync
                  image: hmctspublic.azurecr.io/check-acr-sync:prod-0bf5a71-20240814143926Z #{"$imagepolicy": "flux-system:arc-sync"}
                  imagePullPolicy: IfNotPresent
                  resources:
                    requests:
                      memory: "64Mi"
                      cpu: "250m"
                    limits:
                      memory: "256Mi"
                      cpu: "500m"
                  env:
                    - name: SLACK_WEBHOOK
                      valueFrom:
                        secretKeyRef:
                          name: monitoring-values
                          key: slack-webhook
                    - name: SLACK_ICON
                      value: flux
                    - name: ACR_MAX_RESULTS
                      value: "3000"
                    - name: ACR_SYNC_DEBUG
                      value: "true"
                    - name: SLACK_CHANNEL
                      value: "${TEAM_NOTIFICATION_CHANNEL}"
                    - name: AKS_CLUSTER
                      value: "${ENVIRONMENT}"
                    - name: CLUSTER_NAME
                      value: "cft-${CLUSTER_FULL_NAME}-aks"
                  envFrom:
                    - secretRef:
                        name: acr-sync