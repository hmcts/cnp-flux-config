apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traefik2
  namespace: admin
  annotations:
    # Traefik v39.0.0+ enables schema validation so these additional fields are not allowed anymore
    hmcts.github.com/kustomize-defaults: disabled
spec:
  values:
    # TODO: temporary fix to remove values.access from helm release as it is being merged alongside the new values.logs.access from the base due to the default strategic merge behaviour
    # but this is not allowed by traefik2 helm chart schema, once all envs are tested and traefik2/traefik2.yaml is updated this can be removed
    access:
      $patch: delete
      enabled: true
    logs:
      access:
        enabled: true
    # TODO: temporary fix to remove values.ports.websecure.tls from helm release as it is being merged alongside the new values.ports.websecure.http.tls from the base due to the default strategic merge behaviour
    # but this is not allowed by traefik2 helm chart schema, once all envs are tested and traefik2/traefik2.yaml is updated this can be removed
    ports:
      $patch: replace
      websecure:
        http:
          tls:
            enabled: false
    service:
      spec:
        loadBalancerIP: "10.48.95.250"
    deployment:
      podLabels:
        useWorkloadIdentity: "true"
    serviceAccount:
      name: admin