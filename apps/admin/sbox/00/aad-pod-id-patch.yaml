apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nmi
spec:
  tolerations:
  - effect: NoSchedule
    key: CriticalAddonsOnly
    operator: Equal
    value: "true"
  affinity:
    podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
          labelSelector:
        matchExpressions:
        - key: app
          operator: In
          values:
          - nmi
            topologyKey: "kubernetes.io/hostname"
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 1
      preference:
    matchExpressions:
    - key: kubernetes.azure.com/mode
      operator: In
      values:
      - system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mic
spec:
  tolerations:
  - effect: NoSchedule
    key: CriticalAddonsOnly
    operator: Equal
    value: "true"
  affinity:
    podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
          labelSelector:
        matchExpressions:
        - key: app
          operator: In
          values:
          - mic
            topologyKey: "kubernetes.io/hostname"  
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 1
      preference:
    matchExpressions:
    - key: kubernetes.azure.com/mode
      operator: In
      values:
      - system