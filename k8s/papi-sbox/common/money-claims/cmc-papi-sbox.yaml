---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: cmc-papi-sbox
  namespace: money-claims
  annotations:
    flux.weave.works/automated: "true"
    flux.weave.works/tag.java: glob:prod-*
spec:
  releaseName: cmc-papi-sbox
  timeout: 900
  forceUpgrade: true
  rollback:
    enable: true
    force: true
  chart:
    repository: https://hmctspublic.azurecr.io/helm/v1/repo/
    name: cmc
    version: 0.0.3
  values:
    ### CMC SERVICES ###
    cmc-claim-store:
      java:
        releaseNameOverride: cmc-papi-sbox-claimstore
        secrets: 
          GOV_NOTIFY_API_KEY:
              secretRef: notify-api-key
              key: key
          OAUTH2_CLIENT_SECRET:
              secretRef: oauth-client-secret
              key: key
          IDAM_CASEWORKER_ANONYMOUS_USERNAME:
              secretRef: anonymous-caseworker-username
              key: key
          IDAM_CASEWORKER_ANONYMOUS_PASSWORD:
              secretRef: anonymous-caseworker-password
              key: key
          IDAM_CASEWORKER_SYSTEM_USERNAME:
              secretRef: system-update-username
              key: key
          IDAM_CASEWORKER_SYSTEM_PASSWORD:
              secretRef: system-update-password
              key: key
        environment:
          IDAM_API_URL: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
          FEATURE_TOGGLES_CCD_ENABLED: true
          FEATURE_TOGGLES_CCD_ASYNC_ENABLED: false
          FEATURE_TOGGLES_SAVE_CLAIM_STATE_ENABLED: true
          FEATURE_TOGGLES_ASYNC_EVENT_OPERATIONS_ENABLED: true
          FEATURE_TOGGLES_EMAILTOSTAFF: true
          CLAIM_STORE_DB_HOST: cmc-papi-sbox-postgres
          CMC_DB_HOST: cmc-papi-sbox-postgres
          CORE_CASE_DATA_API_URL: http://cmc-papi-sbox-data-store-api
          IDAM_S2S_AUTH_URL: http://cmc-papi-sbox-s2s
          PDF_SERVICE_URL: http://cmc-papi-sbox-pdf
          SEND_LETTER_URL: http://cmc-papi-sbox-sendletter
          DOCUMENT_MANAGEMENT_URL: http://cmc-papi-sbox-dmstore
          FRONTEND_BASE_URL: https://cmc-citizen-frontend.service.core-compute-papi-sbox.internal
          RESPOND_TO_CLAIM_URL: https://cmc-citizen-frontend.service.core-compute-papi-sbox.internal/first-contact/start
          SPRING_MAIL_HOST: mailhog
          SPRING_MAIL_PORT: 1025
          SPRING_MAIL_PROPERTIES_MAIL_SMTP_SSL_TRUST: mailhog
          SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: false

      ccd:
        idamApiUrl: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
        idamWebUrl: http://idam-web-public-idam-sandbox.service.core-compute-idam-sandbox.internal
        ingressHost: ccd-cmc-citizen-frontend.service.core-compute-papi-sbox.internal
        s2sUrl: http://cmc-papi-sbox-s2s
        draftStoreUrl: http://cmc-papi-sbox-draftstore
        paymentsUrl: http://cmc-papi-sbox-payments
        apiGateway:
          s2sKey: AAAAAAAAAAAAAAAA
          idamClientSecret: 
            fromSecret: true
            secretKeyRefName: ccd-api-gateway-oauth2-client-secret
            secretKeyRefKey: key
        dataStoreApi:
          s2sKey: AAAAAAAAAAAAAAAA
        definitionStoreApi:
          s2sKey: AAAAAAAAAAAAAAAA
        adminWeb:
          s2sKey: AAAAAAAAAAAAAAAA
          idamClientSecret: 
            fromSecret: true
            secretKeyRefName: ccd-admin-web-oauth2-client-secret
            secretKeyRefKey: key
        idam-pr:
          api:
            url: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
          web_public:
            url: http://idam-web-public-idam-sandbox.service.core-compute-idam-sandbox.internal
          releaseNameOverride: cmc-papi-sbox-ccd-idam-pr
          redirect_uris:
            CCD:
              - https://case-management-web-ccd-cmc-citizen-frontend.service.core-compute-papi-sbox.internal/oauth2redirect
            CCD Admin:
              - https://admin-web-ccd-cmc-citizen-frontend.service.core-compute-papi-sbox.internal/oauth2redirect
        importer:
          userprofile:
            userProfileDatabaseHost: cmc-papi-sbox-postgres
          definition:
            importerFromSecret: true
            importerUsername: 
              secretKeyRefName: ccd-importer-username
              secretKeyRefKey: key
            importerPassword: 
              secretKeyRefName: ccd-importer-password
              secretKeyRefKey: key
            redirectUri: "https://case-management-web-ccd-cmc-citizen-frontend.service.core-compute-papi-sbox.internal/oauth2redirect"
        postgresql:
          nameOverride: postgres

    cmc-citizen-frontend:
      nodejs:
        ingressHost: cmc-citizen-frontend.service.core-compute-papi-sbox.internal
        releaseNameOverride: cmc-papi-sbox-citizen-web
        secrets:
          OAUTH_CLIENT_SECRET:
              secretRef: citizen-oauth-client-secret
              key: key
        environment:
          IDAM_API_URL: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
          IDAM_AUTHENTICATION_WEB_URL: http://idam-web-public-idam-sandbox.service.core-compute-idam-sandbox.internal
          FEATURE_TOGGLES_API_URL: http://cmc-papi-sbox-ftrtgl
          CLAIM_STORE_URL: http://cmc-papi-sbox-claimstore
          IDAM_S2S_AUTH: http://cmc-papi-sbox-s2s
          PAY_URL: http://cmc-papi-sbox-payments
          FEES_URL: http://cmc-papi-sbox-fees
          DRAFT_STORE_URL: http://cmc-papi-sbox-draftstore
      idam-pr:
        api:
          url: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
        web_public:
          url: http://idam-web-public-idam-sandbox.service.core-compute-idam-sandbox.internal
        service:
          redirect_uri: https://cmc-citizen-frontend.service.core-compute-papi-sbox.internal/receiver
      rpe-feature-toggle-api:
        importer:
          apiUrl: http://cmc-papi-sbox-ftrtgl/api/ff4j/store/features/
        java:
          releaseNameOverride: cmc-papi-sbox-ftrtgl
          environment:
            FEATURES_DB_HOST: cmc-papi-sbox-postgres
    ########################

    ##### DEPENDENCIES #####
    rpe-send-letter-service:
      java:
        releaseNameOverride: cmc-papi-sbox-sendletter
        environment:
          FLYWAY_URL: "jdbc:postgresql://cmc-papi-sbox-postgres:5432/send_letter"
          LETTER_TRACKING_DB_HOST: cmc-papi-sbox-postgres
          S2S_URL: http://cmc-papi-sbox-s2s

    dm-store:
      java:
        releaseNameOverride: cmc-papi-sbox-dmstore
        environment:
          IDAM_USER_BASE_URI: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
          IDAM_S2S_BASE_URI: http://cmc-papi-sbox-s2s
          SPRING_DATASOURCE_URL: "jdbc:postgresql://cmc-papi-sbox-postgres:5432/evidence"

    cmc-pdf-service:
      java:
        releaseNameOverride: cmc-papi-sbox-pdf

    draft-store-service:
      java:
        releaseNameOverride: cmc-papi-sbox-draftstore
        environment:
          IDAM_URL: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
          S2S_URL: http://cmc-papi-sbox-s2s
          DRAFT_STORE_DB_HOST: cmc-papi-sbox-postgres

    fees-register-api:
      java:
        releaseNameOverride: cmc-papi-sbox-fees
        environment:
          SPRING_DATASOURCE_URL: "jdbc:postgresql://cmc-papi-sbox-postgres:5432/fees_register"

    payment-api:
      java:
        releaseNameOverride: cmc-papi-sbox-payments
        secrets: 
          GOV_PAY_AUTH_KEY_CMC:
              secretRef: gov-pay-keys-cmc
              key: key
        environment:
          AUTH_IDAM_CLIENT_BASEURL: http://idam-api-idam-sandbox.service.core-compute-idam-sandbox.internal
          AUTH_PROVIDER_SERVICE_CLIENT_BASEURL: http://cmc-papi-sbox-s2s
          FEES_REGISTER_URL: http://cmc-papi-sbox-fees
          SPRING_DATASOURCE_URL: "jdbc:postgresql://cmc-papi-sbox-postgres:5432/payment_api"
          SPRING_MAIL_HOST: mailhog
          SPRING_MAIL_PORT: 1025

    rpe-service-auth-provider:
      java:
        releaseNameOverride: cmc-papi-sbox-s2s

    postgresql:
      nameOverride: postgres
    ########################