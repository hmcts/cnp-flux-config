---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: backstage
  namespace: backstage
spec:
  releaseName: backstage
  rollback:
    enable: true
    retry: true
  chart:
    repository: https://hmcts.github.io/RoadieHQ-helm-charts
    name: backstage
    version: 0.2.3
  valueFileSecrets:
    - name: "backstage-values"
  values:
    frontend:
      replicaCount: 2
      image:
        repository: hmctspublic.azurecr.io/backstage/frontend
        tag: latest
    ingress:
      annotations:
        kubernetes.io/ingress.class: traefik
      enabled: true
      hosts:
        - host: backstage.sandbox.platform.hmcts.net
          paths:
            - service: frontend
        - host: backstage-api.sandbox.platform.hmcts.net
          paths:
            - service: backend
    backend:
      replicaCount: 2
      image:
        repository: hmctspublic.azurecr.io/backstage/backend
        tag: latest
    pg:
      # This must match the path provided to appConfig.backend.postgresPathToCa. For example, if
      # postgresPathToCa is /etc/config/my-ca.crt then pg.caVolumeMountDir must be /etc/config.
      caVolumeMountDir: /etc/config

    appConfig:
      app:
        baseUrl: https://backstage.sandbox.platform.hmcts.net
        title: HMCTS Backstage
      backend:
        baseUrl: https://backstage-api.sandbox.platform.hmcts.net
        lighthouseHostname: https://lighthouse.example.com
        gitOpsHostname: https://gitops.example.com
        listen: 0.0.0.0:7000
        cors:
          origin: https://backstage.sandbox.platform.hmcts.net
        postgresUser: backstage@hmcts-backstage-sbox
        postgresPort: 5432
        postgresDatabase: backstage
        postgresHost: hmcts-backstage-sbox.postgres.database.azure.com
        postgresPathToCa: /etc/config/ca-cert.pem
