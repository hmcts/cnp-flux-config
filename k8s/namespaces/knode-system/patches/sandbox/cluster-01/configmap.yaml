apiVersion: v1
data:
  daemon.json: |
    {
      "live-restore": true,
      "log-driver": "json-file",
      "log-opts":  {
        "max-size": "50m",
        "max-file": "5"
      },
      "data-root": "/mnt/docker"
    }
kind: ConfigMap
metadata:
  name: knode-config
  namespace: knode-system

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: knode-config
  namespace: knode-system
data:
  # disable-ipv6
  run.privileged: |
    target: 1
    instructions:
      - sh
      - -c
      - |
        if ip a | grep "inet6"; then
          echo ipv6 is not disabled
          if cat /etc/default/grub | grep "GRUB_CMDLINE_LINUX_DEFAULT=" | grep "ipv6.disable=1"; then
            echo GRUB_CMDLINE_LINUX_DEFAULT is already disabled
          else
            echo disabling GRUB_CMDLINE_LINUX_DEFAULT
            sed -i 's/\bGRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="ipv6.disable=1 /g' /etc/default/grub
          fi
          if cat /etc/default/grub | grep "GRUB_CMDLINE_LINUX=" | grep "ipv6.disable=1"; then
            echo GRUB_CMDLINE_LINUX is already disable
          else
            echo disabling GRUB_CMDLINE_LINUX
            sed -i 's/\bGRUB_CMDLINE_LINUX="/GRUB_CMDLINE_LINUX="ipv6.disable=1 /g' /etc/default/grub
          fi
          update-grub
          # reboot
        else
          echo ipv6 is already disabled
        fi
        while true; do sleep 100000; done
