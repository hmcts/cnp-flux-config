---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: oauth2-proxy
  namespace: admin
spec:
  template:
    metadata:
      labels:
        app: oauth2-proxy
    spec:
      volumes:
      - name: oauth2-certs
        secret:
          secretName: oauth2-cert-key
      containers:
      - name: oauth2-proxy
        image: quay.io/pusher/oauth2_proxy:v3.2.0-amd64
        ports:
         - name: http
           containerPort: 4180
           protocol: TCP         
         - name: https
           containerPort: 4443
           protocol: TCP
        resources:
          limits:
            cpu: 100m
            memory: 256Mi
          requests:
            cpu: 10m
            memory: 128Mi
        volumeMounts:
           - mountPath: "/var/oauth2"
             name: "oauth2-certs"
             readOnly: true
        env:
          - name: OKTA_PROXY_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: okta-client-secret
                key: okta-proxy-client-id
          - name: OKTA_PROXY_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: okta-client-secret
                key: okta-proxy-client-secret
          - name: OKTA_PROXY_COOKIE_SECRET
            valueFrom:
              secretKeyRef:
                name: okta-client-secret
                key: okta-proxy-cookie-secret
        args:
          - "--provider=oidc"
          - "--email-domain=*"
          - "--http-address=:4180"
          - "--https-address=:4443"
          - "--ssl-insecure-skip-verify=true"
          - "--oidc-issuer-url=https://outlookcpreda.okta.com"
          - "--skip-provider-button=true"
          - "--pass-host-header=true"
          - "--pass-access-token=true"
          - "--request-logging"
          - "--upstream=http://traefik:80/"
          - "--tls-cert=/var/oauth2/aks-sandbox-internal-crt.pem"
          - "--tls-key=/var/oauth2/aks-sandbox-internal-key.pem"
---
kind: Service
apiVersion: v1
metadata:
  name: oauth2-proxy
  namespace: admin
spec:
  loadBalancerIP: 10.10.89.251
  type: LoadBalancer
  selector:
    app: oauth2-proxy
  ports:
  - protocol: TCP
    port: 80
    name: http
    targetPort: 4180
  - protocol: TCP
    port: 443
    name: https
    targetPort: 4443