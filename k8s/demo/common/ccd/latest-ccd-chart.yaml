---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: ccd-demo
  namespace: ccd
  annotations:
    flux.weave.works/automated: 'true'
    flux.weave.works/tag.java: 'glob:prod-*'
spec:
  releaseName: ccd-demo
  timeout: 900
  forceUpgrade: true
  rollback:
    enable: true
    force: true
  chart:
    repository: 'https://hmctspublic.azurecr.io/helm/v1/repo/'
    name: ccd
    version: 4.0.7-alpha
  values:
    tags:
      idam-pr: true
    global:
      ccdApiGatewayIngress: gateway-ccd-aks.demo.platform.hmcts.net
      ccdCaseManagementWebIngress: www-ccd-aks.demo.platform.hmcts.net
      ccdAdminWebIngress: ccd-admin-web-aks.demo.platform.hmcts.net
      # can ingressHost be removed?
      ingressHost: chart-ccd.demo.platform.hmcts.net
#     TODO remove protocol to allow better reusability?
      idamApiUrl: https://idam-api.demo.platform.hmcts.net
      idamWebUrl: https://idam-web-public.demo.platform.hmcts.net
      # can redirectUri be removed?
      redirectUri: https://ccd-demo-case-management-web.demo.platform.hmcts.net/oauth2redirect
      s2sUrl: http://ccd-demo-s2s

    ccd-api-gateway-web:
      nodejs:
        ingressClass: traefik-no-proxy
        ingressHost: gateway-ccd-aks.demo.platform.hmcts.net
        secrets:
          IDAM_OAUTH2_CLIENT_SECRET:
            secretRef: ccd-api-gateway-oauth2-client-secret
            key: key
    ccd-case-management-web:
      nodejs:
        releaseNameOverride: ccd-demo-case-management-web
        ingressHost: www-ccd-aks.demo.platform.hmcts.net
        environment:
          # TODO move this to ccd-chart
          DM_URL_REMOTE: "^https?://(?:dm-store(?::\\d+)?)/documents"
    ccd-admin-web:
      nodejs:
        ingressClass: traefik-no-proxy
        ingressHost: ccd-admin-web-aks.demo.platform.hmcts.net
        secrets:
          IDAM_OAUTH2_AW_CLIENT_SECRET:
            secretRef: ccd-admin-web-oauth2-client-secret
            key: key
        environment:
          ADMINWEB_LOGIN_URL: https://idam-web-public.demo.platform.hmcts.net/login
    ccd-definition-store-api:
      java:
        memoryRequests: "1G"
        memoryLimits: "2G"
    # CCD Supporting services
    ccd-case-activity-api:
      nodejs:
        environment:
          CORS_ORIGIN_WHITELIST: '{{ .Values.global.ccdCaseManagementWebIngress }}'
    
    ccd-test-stubs-service:
      java:
        ingressHost: test-stubs-service-ccd-aks.demo.platform.hmcts.net
        environment:
          MANAGEMENT_WEB_URL: www-ccd-aks.demo.platform.hmcts.net

    #Dependencies

#    TODO move dm-store on chart-ccd and remove it here
    dm-store:
      java:
        secrets:
          STORAGE_ACCOUNT_NAME:
            disabled: false
            secretRef: storage-secret-ccd-demo
            key: storageAccountName
          STORAGE_ACCOUNT_KEY:
            disabled: false
            secretRef: storage-secret-ccd-demo
            key: accessKey
          STORAGE_CONTAINER_DOCUMENT_CONTAINER_NAME:
            disabled: false
            secretRef: container-secret-ccd-demo-dm-docstore
            key: containerName
        environment:
          MAX_FILE_SIZE: '100MB'
          ENABLE_AZURE_STORAGE_CONTAINER: 'true'
          POSTGRES_STORAGE_ENABLED: 'false'
          STORAGEACCOUNT_PRIMARY_CONNECTION_STRING: "DefaultEndpointsProtocol=https;AccountName=$(STORAGE_ACCOUNT_NAME);AccountKey=$(STORAGE_ACCOUNT_KEY);EndpointSuffix=core.windows.net"
      blobstorage:
        enabled: true
    rpe-service-auth-provider:
      java:
        releaseNameOverride: ccd-demo-s2s

