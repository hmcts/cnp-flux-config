apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
bases:
  - ../../namespaces/admin/flux
  - ../../namespaces/admin/fluxcloud
  - ../../namespaces/admin/flux-helm-operator
  - ../../namespaces/admin/external-dns
  - ../../namespaces/all-namespaces/edit-clusterrole.yaml
  - ../../namespaces/osba
  - ../../namespaces/admin/keda
  - ../../namespaces/kube-system/container-azm-ms-agentconfig
  - ../../namespaces/admin/flux-helm-operator/rbac/read-only-rbac.yaml
  - ../../namespaces/admin/flux-helm-operator/rbac/preview-role-binding.yaml

patchesStrategicMerge:
  #flux patches
  - ../../namespaces/admin/flux/patches/preview/flux.yaml
  - ../../namespaces/admin/flux/patches/preview/cluster-01/flux.yaml

  - ../../namespaces/admin/flux-helm-operator/patches/disable-rbac.yaml

  #fluxcloud patch
  - ../../namespaces/admin/fluxcloud/patches/preview/cluster-01/fluxcloud.yaml

  #osba patch
  - ../../namespaces/osba/patches/preview/osba.yaml

  - ../../namespaces/admin/external-dns/patches/preview/cluster-01/external-dns-deployment.yaml

patches:
  - path: ../preview-helmrelease.yaml
    target:
      kind: HelmRelease
      annotationSelector: hmcts.github.com/global-defaults == enabled
  - path: ../automated-helmrelease.yaml
    target:
      kind: HelmRelease
      annotationSelector: hmcts.github.com/prod-automated == enabled
